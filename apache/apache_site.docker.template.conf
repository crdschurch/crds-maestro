<VirtualHost *:80>
	# The ServerName directive sets the request scheme, hostname and port that
	# the server uses to identify itself. This is used when creating
	# redirection URLs. In the context of virtual hosts, the ServerName
	# specifies what hostname must appear in the request's Host: header to
	# match this virtual host. For the default virtual host (this file) this
	# value is not decisive as it is used as a last resort host regardless.
	# However, you must set it for any further virtual host explicitly.
	# ServerName www.example.com
	ServerName ${CRDS_SERVER_NAME}
	ServerAdmin webmaster@localhost
	DocumentRoot ${CRDS_WEBSITE_PATH}

	Redirect /discipleship https://discipleship.crossroads.net/


	# Setup reverse proxy for gateway and content. This will 
	# eliminate CORS preflight calls, helping performance of the site.
	SSLProxyEngine on
	
	RewriteRule ^/?proxy/gateway/(.*) $CRDS_GATEWAY_SERVER_ENDPOINT/$1 [P]
	ProxyPassReverse /proxy/gateway/ $CRDS_GATEWAY_SERVER_ENDPOINT

	RewriteRule ^/?proxy/services/(.*) $CRDS_SERVICES_SERVER_ENDPOINT/$1 [P]
	ProxyPassReverse /proxy/services/ $CRDS_SERVICES_SERVER_ENDPOINT

	RewriteRule ^/?proxy/content/(.*) $CRDS_CMS_SERVER_ENDPOINT/$1 [P]
	ProxyPassReverse /proxy/content/ $CRDS_CMS_SERVER_ENDPOINT

	# Prevent accessing .conf files
	<Files ~ "\.(conf)$">
		Deny from all
	</Files>

	RewriteEngine On

	# Proxy to Phoenix
	ProxyPass / http://$MAESTRO_HOSTNAME:$MAESTRO_PORT/
	ProxyPassReverse / http://$MAESTRO_HOSTNAME:$MAESTRO_PORT/ 
	

	# Browser security config (allow CMS to iframe)
	Header set Content-Security-Policy "frame-ancestors 'self' *.crossroads.net;"
	Header set x-xss-protection "1; mode=block"
	Header set x-content-type-options "nosniff"
	

	# Begin US8135: Allow iframing for /atriumevents
	<Location "/atriumevents">
	  Header unset Content-Security-Policy
	</Location>
	# End US8135: Allow iframing for /atriumevents
	
</VirtualHost>
