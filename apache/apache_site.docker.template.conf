<VirtualHost *:80>
	# The ServerName directive sets the request scheme, hostname and port that
	# the server uses to identify itself. This is used when creating
	# redirection URLs. In the context of virtual hosts, the ServerName
	# specifies what hostname must appear in the request's Host: header to
	# match this virtual host. For the default virtual host (this file) this
	# value is not decisive as it is used as a last resort host regardless.
	# However, you must set it for any further virtual host explicitly.
	# ServerName www.example.com
	ServerName ${CRDS_SERVER_NAME}
	ServerAdmin webmaster@localhost
	DocumentRoot ${CRDS_WEBSITE_PATH}

	Redirect /discipleship https://discipleship.crossroads.net/


	# Setup reverse proxy for gateway and content. This will 
	# eliminate CORS preflight calls, helping performance of the site.
	SSLProxyEngine on
	
	RewriteRule ^/?proxy/gateway/(.*) $CRDS_GATEWAY_SERVER_ENDPOINT/$1 [P]
	ProxyPassReverse /proxy/gateway/ $CRDS_GATEWAY_SERVER_ENDPOINT

	RewriteRule ^/?proxy/services/(.*) $CRDS_SERVICES_SERVER_ENDPOINT/$1 [P]
	ProxyPassReverse /proxy/services/ $CRDS_SERVICES_SERVER_ENDPOINT

	RewriteRule ^/?proxy/content/(.*) $CRDS_CMS_SERVER_ENDPOINT/$1 [P]
	ProxyPassReverse /proxy/content/ $CRDS_CMS_SERVER_ENDPOINT

	# Prevent accessing .conf files
	<Files ~ "\.(conf)$">
		Deny from all
	</Files>

	RewriteEngine On

	# Proxy to Phoenix
	RewriteRule ^/(.*) http://$MAESTRO_HOSTNAME:$MAESTRO_PORT/$1 [P,L]
	ProxyPassReverse / http://$MAESTRO_HOSTNAME:$MAESTRO_PORT/ 
	
	# Begin Settings for mod_cache
	# Adjust header to avoid inappropriate invalidation
	<LocationMatch "(?i)^/+proxy/+content/+api">
	  RequestHeader unset If-Modified-Since
	  RequestHeader unset If-None-Match
	  RequestHeader unset Cache-Control
	  RequestHeader unset Pragma
	  RequestHeader set Cache-Control "max-age=600"
	  RequestHeader unset Cookie
	  RequestHeader unset User-Agent
	  RequestHeader unset ImpersonateUserId
	  Header unset ETag
	  Header set Cache-Control "max-age=600"
	  FileETag None
	</LocationMatch>

	# Basic settings
	CacheQuickHandler off
	CacheLock on
	CacheLockPath /tmp/mod_cache-lock
	CacheLockMaxAge 5

	# Do not send back cookies in our responses
	CacheIgnoreHeaders Set-Cookie
	
	# Options to ignore client forcing of new request
	CacheIgnoreCacheControl on
	
	# Send back info to client
	CacheHeader on
	CacheDetailHeader on

	# Set expirations
	CacheDefaultExpire 600
	CacheMaxExpire 86400
	CacheLastModifiedFactor 0.5	
  # CacheStoreExpired On

	# Browser security config (allow CMS to iframe)
	Header set Content-Security-Policy "frame-ancestors 'self' *.crossroads.net;"
	Header set x-xss-protection "1; mode=block"
	Header set x-content-type-options "nosniff"

	# Define Locations
	<LocationMatch "(?i)^/+proxy/+content/+api/+ContentBlock">
	  CacheEnable disk
	</LocationMatch>

	<LocationMatch "(?i)^/+proxy/+content/+api/+SiteConfig/+1">
	  CacheEnable disk
	</LocationMatch>
	
	<LocationMatch "(?i)^/+proxy/+content/+api/+singleMedia">
	  CacheEnable disk
	</LocationMatch>

	<LocationMatch "(?i)^/+proxy/+content/+api/+message">
	  #CacheEnable disk
	</LocationMatch>

	<LocationMatch "(?i)^/+proxy/+content/+api/+messages">
	  CacheEnable disk
	</LocationMatch>

	<LocationMatch "(?i)^/+proxy/+content/+api/+series">
	  CacheEnable disk
	</LocationMatch>

	<LocationMatch "(?i)^/+proxy/+content/+api/+SystemPage">
	  CacheEnable disk
	</LocationMatch>
	
	<LocationMatch "(?i)^/+proxy/+content/+api/+feature">
	  CacheEnable disk
	</LocationMatch>

	<LocationMatch "(?i)^/+proxy/+content/+api/+features">
	  CacheEnable disk
	</LocationMatch>

	<LocationMatch "(?i)^/+proxy/+content/+api/+groupresourcecategory">
	  CacheEnable disk
	</LocationMatch>
	# End Location definitions
	# End mod_cache settings

	# Begin US8135: Allow iframing for /atriumevents
	<Location "/atriumevents">
	  Header unset Content-Security-Policy
	</Location>
	# End US8135: Allow iframing for /atriumevents
	
</VirtualHost>
